# Cloud Storage API
## Content
- [Description](#description)
- [Requirements](#requirements)
- [Technology used](#technology-used)
- [Google Cloud Platform](#google-cloud-platform)
   - [Instructions](#instructions)
   - [Set up Google Cloud Storage](#set-up-gcs)
- [Amazon Web Services](#amazon-web-services)
   - [Instructions](#instructions-1)
   - [Set up S3](#set-up-s3)
- [Azure](#azure)
   - [Instructions](#instructions-2)
   - [Set up Blob Storage](#set-up-blob-storage)

## Description
Single REST API which demonstrates dependencies decoupling when our applications relies on 3rd party services.
In this case we rely on a Storage Cloud Provider, we need to make sure it is easily switchable to another cloud provider.<br><br>
**Note: Testing with GCP/AWS/Azure might involve some real charges to your account, please be aware of it and follow [Steps to test](#steps-to-test) in order to avoid unnecessary charges**

[Go to top](#content)
## Requirements

- Having an active/valid google cloud platform account.
- Having an active/valid Amazon Web Services account.
- Having an active/valid Azure account.
- Visual Studio
- TablePlus (or any other SQLite Manager)

[Go to top](#content)

## Technology used

- .Net Core 6
- SQLite
- GCS (Google Cloud Storage)
- Amazon S3 (Cloud Object Storage)
- Azure Blob Storage

[Go to top](#content)

## Google Cloud Platform

### Instructions
1. Download/clone this repo locally
2. Set up GCS Bucket, SA and IAM permissions. See [How to set up GCS](#set-up-gcs) for more details.
3. Modify appsettings.json.
   - Change **GCS** section:
     - BucketName: globally unique bucket name created.
     - ServiceAccountKeyFileName: downloaded json file's name with SA's key. See steps 5-7 of [How to set up GCS](#set-up-gcs)
4. Run migrations by executing over **CloudStorage.Core**: Update-Database in "Package Manager Console". Note: sometime it's necessary install first: Install-Package Microsoft.EntityFrameworkCore.Tools

[Go to top](#content)
### Set up GCS
1. Go to <a href="https://console.cloud.google.com" target="_blank">GCP Console</a>
2. Create a new project if you don't have one yet. Discover how
   <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects#creating_a_project" target="_blank">here</a>
3. Create a bucket in Google Cloud Storage, **with these params**. Discover how <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects#creating_a_project" target="_blank">here</a>
   - Bucket name: _This is your choise_, **need to be globally unique**.
   - Location type: _Region, us-central1_
   - Storage class: _Standard_
   - Prevent public access: _Unchecked_
   - Access control: _Uniform_
   - Protection tools: _None_
4. Once bucket is created go to bucket detail > Permissions
   - Click on _GRANT ACCESS_
   - Add Principals: Type **allUsers** and select it from options.
   - Assign Roles: Select **Storage Object Viewer**
   - Click on _SAVE_
5. Create a new Service Account (SA) to upload data into your bucket with following params. Discover how <a href="https://cloud.google.com/iam/docs/service-accounts-create" target="_blank">here</a>:
   - Service account name: _This is your choice_
   - Service account ID: _This is autogenerated based on previous field_
   - Service account description: _Your choise_ (optional)
   - Select a role: Select **Storage Object Creator**
   - Click _CONTINUE_
   - Click _DONE_
6. Create a JSON Key for your SA.
   - Go to SA's details
   - Click on _KEYS_ tabs
   - Click on _ADD KEY_ dropdown
   - Select _Create new key_
   - Select _JSON_, click _CREATE_
   - A new json file will be downloaded.
7. Move the downloaded json file to `/CloudStorageAPI/CloudStorageAPI/sa-key/` folder

[Go to top](#content)
## Amazon Web Services
### Instructions
1. Download/clone this repo locally
2. Set up S3 Bucket. See [How to set up S3 Bucket in AWS](#set-up-s3) for more details.
3. Modify appsettings.Development.json.
   - Change **AWS** section:
      - BucketName: globally unique bucket name created.
      - AccessKeyId: Access key from IAM user. See
      - SecretAccessId: Scret access key from IAM user.

[Go to top](#content)
### Set up S3
1. Go to [AWS Console](https://us-east-2.console.aws.amazon.com/console/home?nc2=h_ct&region=us-east-2&src=header-signin#)
2. Go to [Amazon S3](https://s3.console.aws.amazon.com/s3/home?region=us-east-2#) and setup a new bucket with these params and *leave all others as they are originally*.
   - Bucket Name: *This your choice*, **it needs to be globally unique.**
   - AWS Region: Us East (Ohio) us-east-2
   - Block all public access: **Unselected**. *Note this is only for testing purpose in prod this is not recommended.*
   - Check options:
      1. Block public access to buckets and objects granted through new access control lists (ACLs)
      2. Block public access to buckets and objects granted through any access control lists (ACLs)
      3. *Leave others unchecked*
   - **Check** the requested option *I acknowledge that the curret settings might result in this bucket and the objects within become public*
3. Once bucket has been created go to details by clicking the record in [buckets list](https://s3.console.aws.amazon.com/s3/buckets?region=us-west-2)
4. Click on **Permissions** tab, then click **Edit** button in **Bucket policy** section
5. Set this in the new **policy** and replace &lt;bucket-name&gt; with your bucket name configured in step 2.
``` {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicRead",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::<bucket-name>/*"
        }
    ]
```
6. Click on **Save changes**
7. Go to [IAM service](https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-west-2#/home) in AWS
8. In the left navigation menu go to **Users** and click in **Create user** button
9. Configure an user name and click on **Next**
10. Configure a new user group:
   - Click on **Create group**
   - Set an **User group name**
   - Select/search for **AmazonS3FullAccess** policy within **Permissions policies**. *Note this is only for testing purposes due to it's a bad practice and it shouldn't be done like this in a production implementation.*
   - Click on **Create user group** 
11. Select from the list te just created group then click on **Next** button.
12. Click on **Create user** button to finish the user creation.
13. Once created, click on the user's record from [User list](https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-west-2#/users) to see details.
14. Click on **Security credentials** tab and scroll own till **Access keys** section.
15. Click on **Create access key**.
16. Select **Application running outside AWS** option and click on **Next**.
17. Leave the Description tag value field empty and then click on **Create access key** button.
18. Copy **Access key** and **Secret access Key**
19. Paste copied values within appsettings.Development.json within **AWS** section.

[Go to top](#content)
## Azure
[Go to top](#content)
### Set up Blob Storage
1. Create a [Resource group](https://portal.azure.com/#create/Microsoft.ResourceGroup)
2. Create a [storage account](https://portal.azure.com/#create/Microsoft.StorageAccount-ARM)
   - Resource Group: Select the resource group created in step 1
   - Region: (US) Central US
   - Performance: Standard
   - Redundancy: Locally-redundant storage (LRS)
   - Click on **Advanced** tab
   - Check option *Allow enabling anonymous access on individual containers*
   - *Leave other options/fields with default values*
3. Once created **Go to resource** detail.
4. Click on **Blob service** option and create a new **Container**
   - Name: is your choice, set this up within appsettings.Development.json in Azure section.
   - Anonymous access level: Blob (anonymous read access for blobs only)
5. In Storage account detail page and in left navigation go to **Access keys** within **Security + networking** section
6. Click on **Show** button in the key1->Connection string field and copy the shown value.
7. Paste the copied value in appsettings.Development.json in Azure section.
[Go to top](#content)